<view class="container">
  <!-- Background -->
  <view class="bg-stars"></view>

  <!-- Header -->
  <view class="header">
    <text class="header-text">å–µå‘œ~ æ´æ‚‰è¿‡å» Â· æŠŠæ¡å½“ä¸‹ Â· é¢„è§æœªæ¥</text>
  </view>

  <view class="main-content">
    
    <!-- Intro Stage -->
    <view wx:if="{{stage === 'intro'}}" class="stage intro">
      <image class="intro-avatar" src="https://pic1.imgdb.cn/item/693811d900233646958db503.png" mode="widthFix"></image>
      <view class="intro-card">
        <view class="intro-title">æ¬¢è¿æ¥åˆ°å¡”ç½—ç§˜å¢ƒ</view>
        <view class="intro-desc">æˆ‘æ˜¯è¿™é‡Œçš„å®ˆæŠ¤è€…ï¼Œè®©æˆ‘ç”¨å¡”ç½—ç‰Œä¸ºä½ æŒ‡å¼•æ–¹å‘å–µ~</view>
        <button class="start-btn" bindtap="startIntro">å¼€å§‹å åœ</button>
      </view>
    </view>

    <!-- Input Stage -->
    <view wx:if="{{stage === 'input'}}" class="stage input">
      <view class="question-card">
        <text class="label">å¿ƒä¸­é»˜å¿µä½ çš„é—®é¢˜</text>
        <textarea 
          class="question-input" 
          placeholder="ä¾‹å¦‚ï¼šæˆ‘æœ€è¿‘çš„è¿åŠ¿å¦‚ä½•ï¼Ÿ" 
          value="{{question}}"
          bindinput="onInputQuestion"
        ></textarea>
        <button class="confirm-btn" bindtap="confirmQuestion" disabled="{{!question}}">ç¡®è®¤é—®é¢˜</button>
      </view>
    </view>

    <!-- Spread Selection Stage -->
    <view wx:if="{{stage === 'spread'}}" class="stage spread">
      <view class="spread-title">é€‰æ‹©ç‰Œé˜µ</view>
      <view class="spread-list">
        <block wx:for="{{spreadConfigs}}" wx:key="id">
          <view class="spread-item" bindtap="selectSpread" data-id="{{item.id}}">
            <view class="spread-name">{{item.name}}</view>
            <view class="spread-desc">{{item.description}}</view>
            <view class="spread-cards">éœ€æŠ½å– {{item.cards}} å¼ ç‰Œ</view>
          </view>
        </block>
      </view>
    </view>

    <!-- Shuffle Stage -->
    <view wx:if="{{stage === 'shuffle'}}" class="stage shuffle">
      <view class="shuffle-anim">
        <view class="card back"></view>
        <view class="card back"></view>
        <view class="card back"></view>
      </view>
      <text class="loading-text">æ´—ç‰Œä¸­...</text>
    </view>

    <!-- Cut Stage -->
    <view wx:if="{{stage === 'cut'}}" class="stage cut">
      <view class="cut-deck" bindtap="cutDeck">
        <image src="{{cardBackUrl}}" class="deck-img"></image>
        <text class="cut-hint">ç‚¹å‡»åˆ‡ç‰Œ</text>
      </view>
    </view>

    <!-- Draw Stage -->
    <view wx:if="{{stage === 'draw'}}" class="stage draw">
      <view class="draw-header">
        è¯·æŠ½å– {{selectedSpread.cards}} å¼ ç‰Œ ({{drawnCards.length}}/{{selectedSpread.cards}})
      </view>
      <view class="deck-spread">
        <!-- Simplified visual representation of deck -->
        <view class="card-stack" bindtap="drawCard">
           <image src="{{cardBackUrl}}" class="card-back-lg"></image>
           <text class="draw-hint">ç‚¹å‡»æŠ½ç‰Œ</text>
        </view>
      </view>
      <view class="drawn-preview">
        <block wx:for="{{drawnCards}}" wx:key="uniqueId">
           <image src="{{cardBackUrl}}" class="mini-card"></image>
        </block>
      </view>
    </view>

    <!-- Reading / Result Stage -->
    <view wx:if="{{stage === 'reading' || stage === 'result'}}" class="stage reading">
      <view class="cards-layout">
        <block wx:for="{{drawnCards}}" wx:key="uniqueId">
          <view class="card-slot" bindtap="revealCard" data-index="{{index}}">
            <view class="card-inner {{item.isRevealed ? 'flipped' : ''}}">
              <view class="card-face front">
                <image src="{{item.imageUrl}}" class="card-img {{item.isReversed ? 'reversed' : ''}}" mode="widthFix"></image>
                <view class="card-label">{{item.name}} {{item.isReversed ? '(é€†ä½)' : '(æ­£ä½)'}}</view>
              </view>
              <view class="card-face back">
                <image src="{{cardBackUrl}}" class="card-back-img"></image>
                <view class="position-label">{{item.position}}</view>
              </view>
            </view>
          </view>
        </block>
      </view>

      <block wx:if="{{stage === 'result' && readingResult}}">
        <view class="result-card">
          <view class="result-title">ğŸ”® è§£è¯»ç»“æœ</view>
          <view class="result-text">{{readingResult.analysis}}</view>
          <view class="advice-title">ğŸ’¡ å»ºè®®</view>
          <view class="result-text">{{readingResult.advice}}</view>
          <button class="reset-btn" bindtap="reset">é‡æ–°å åœ</button>
        </view>
      </block>
       <block wx:elif="{{loading}}">
         <view class="loading-reading">æ­£åœ¨è§£è¯»...</view>
       </block>
    </view>

  </view>

  <view class="back-btn" bindtap="onBack">
    <text>â¬… è¿”å›</text>
  </view>
</view>
