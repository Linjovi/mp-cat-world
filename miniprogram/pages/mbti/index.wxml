<view class="container">
  <!-- Header -->
  <view class="header" style="background-color: {{mbtiColor}}">
    <view class="nav-btn" bindtap="handleBack">
      <text class="icon">â®</text>
    </view>
    <text class="header-title">MeowBTI {{targetMBTI}}</text>
    <view class="nav-btn" bindtap="handleReset">
      <text class="icon">â†º</text>
    </view>
  </view>

  <!-- Mian Content -->
  <view class="main-content">
    <!-- Profile Card -->
    <view class="profile-card">
      <view class="profile-bg-icon">ğŸ§ </view>
      
      <view class="profile-avatar-container">
        <image src="{{mbtiAvatar}}" mode="aspectFill" class="profile-avatar"></image>
      </view>
      
      <view class="profile-info">
        <view class="profile-header">
           <text class="mbti-title" style="color: {{mbtiColor}}">{{targetMBTI}}</text>
        </view>
        <view class="profile-reletaion">
           <text class="relation-tag">{{relationshipLabel}}</text>
           <view class="dot"></view>
           <text class="relation-level">LV.{{relationshipIndex}}</text>
        </view>
        <view class="settings-btn" style="background-color: {{mbtiColor}}" bindtap="toggleSettings">
           <text>âš™ï¸ ä¿®æ”¹è®¾å®š</text>
        </view>
      </view>
    </view>

    <!-- Step 1: TA's Message -->
    <view class="card-box">
      <view class="card-header">
        <view class="icon-box" style="background-color: {{mbtiColor}}">âœ‰ï¸</view>
        <text class="card-title">Step 1: TA çš„æ¶ˆæ¯</text>
      </view>
      
      <textarea 
        class="input-area" 
        placeholder="TA è¯´äº†ä»€ä¹ˆå–µï¼Ÿ" 
        value="{{receivedMessage}}"
        bindinput="handleInputReceived"
        maxlength="500"
      ></textarea>
      
      <view class="action-row">
        <view 
          class="action-btn {{isAnalyzing || !receivedMessage ? 'disabled' : ''}}" 
          style="background-color: {{mbtiColor}}"
          bindtap="handleParse"
        >
          <text wx:if="{{isAnalyzing}}">åˆ†æä¸­...</text>
          <text wx:else>ğŸ§  æ·±åº¦è§£æ</text>
        </view>
      </view>

      <view wx:if="{{analysis}}" class="analysis-box">
         <view class="analysis-header">
           <text style="color: {{mbtiColor}}">ğŸ§ </text>
           <text class="analysis-label">æ½œå°è¯é€è§†</text>
         </view>
         <text class="analysis-content">{{analysis.mbtiLogic}}</text>
      </view>
    </view>

    <!-- Connector -->
    <view class="connector">
      <text style="color: {{mbtiColor}}">â¬‡</text>
    </view>

    <!-- Step 2: My Intent -->
    <view class="card-box {{!analysis ? 'opacity-80' : ''}}">
      <view class="card-header">
        <view class="icon-box" style="background-color: {{mbtiColor}}">âœ¨</view>
        <text class="card-title">Step 2: å›å¤æ„å‘</text>
      </view>
      
      <textarea 
        class="input-area" 
        placeholder="ä½ æƒ³è¡¨è¾¾ä»€ä¹ˆå–µï¼Ÿ" 
        value="{{myIntent}}"
        bindinput="handleInputIntent"
        maxlength="500"
      ></textarea>
      
      <view class="action-row">
        <view 
          class="action-btn {{isGeneratingSuggestions || !myIntent ? 'disabled' : ''}}" 
          style="background-color: {{mbtiColor}}"
          bindtap="handleGenerateReply"
        >
          <text wx:if="{{isGeneratingSuggestions}}">ç”Ÿæˆä¸­...</text>
          <text wx:else>âœ¨ ç”Ÿæˆç¥å›å¤</text>
        </view>
      </view>
    </view>

    <!-- Suggestions -->
    <view wx:if="{{suggestions.length > 0}}" class="suggestions-container">
      <view class="divider">
        <view class="line"></view>
        <text class="divider-text">Strategies Generated</text>
        <view class="line"></view>
      </view>
      
      <scroll-view scroll-x class="suggestions-scroll" enable-flex>
        <block wx:for="{{suggestions}}" wx:key="index">
          <view class="suggestion-card" style="border-top-color: {{mbtiColor}}">
            <view class="suggestion-section">
              <text class="section-label">ç›´è§‰ååº”</text>
              <text class="reaction-old">"{{item.reactionToOriginal}}"</text>
            </view>
            
            <view class="suggestion-section">
              <text class="section-label" style="color: {{mbtiColor}}">é™ç»´æ‰“å‡»æ–¹æ¡ˆ</text>
              <view class="optimized-reply" style="background-color: {{mbtiColor}}1a; color: {{mbtiColor}}">
                 {{item.optimizedReply}}
              </view>
              <text class="reaction-new">âœ“ {{item.reactionToOptimized}}</text>
            </view>
            
            <view class="analysis-brief">
               <text class="brief-label">åº•å±‚åšå¼ˆé€»è¾‘</text>
               <text>{{item.briefAnalysis}}</text>
            </view>
            
            <view class="suggestion-footer">
               <view class="score-box">
                 <text class="score-label">å¥½æ„Ÿåº¦å˜åŒ–</text>
                 <view>
                   <text class="score-num">{{item.scoreChange.from}} â†’ </text>
                   <text class="score-num" style="color: {{mbtiColor}}">{{item.scoreChange.to}}</text>
                   <text class="score-diff">+{{item.scoreChange.diff}}</text>
                 </view>
               </view>
               <view 
                 class="copy-btn" 
                 style="background-color: {{mbtiColor}}"
                 bindtap="copyContent"
                 data-content="{{item.optimizedReply}}"
               >
                 å¤åˆ¶
               </view>
            </view>
          </view>
        </block>
      </scroll-view>
    </view>
  </view>

  <!-- Settings Modal -->
  <view wx:if="{{showSettings}}" class="modal-overlay" bindtap="toggleSettings">
     <view class="modal-content" catchtap="true">
        <view class="modal-header">
           <text class="modal-title">äººæ ¼è®¾å®š</text>
           <view class="close-btn" bindtap="toggleSettings">âœ•</view>
        </view>
        
        <view class="setting-section">
           <text class="setting-label">ç›®æ ‡äººæ ¼ (MBTI)</text>
           <view class="mbti-grid">
              <view 
                wx:for="{{mbtiList}}" 
                wx:key="*this"
                class="mbti-item {{targetMBTI === item ? 'active' : ''}}"
                style="{{targetMBTI === item ? 'background-color: ' + mbtiColor + '; border-color: ' + mbtiColor : ''}}"
                bindtap="selectMBTI"
                data-mbti="{{item}}"
              >
                {{item}}
              </view>
           </view>
        </view>
        
        <view class="setting-section">
           <view class="slider-header">
              <text class="setting-label">äº²å¯†åº¦æŒ‡æ•° ({{relationshipIndex}})</text>
              <text class="relation-badge" style="background-color: {{mbtiColor}}">{{relationshipLabel}}</text>
           </view>
           <slider 
             min="0" max="100" 
             value="{{relationshipIndex}}" 
             activeColor="{{mbtiColor}}"
             bindchange="onRelationshipChange"
           />
           <view class="slider-labels">
              <text>Stranger</text>
              <text>Friend</text>
              <text>Lover</text>
           </view>
        </view>
        
        <view class="modal-footer">
           <button class="confirm-btn" style="background-color: {{mbtiColor}}" bindtap="closeSettings">å®Œæˆä¿®æ”¹</button>
        </view>
     </view>
  </view>

  <!-- Toast -->
  <view wx:if="{{showToast}}" class="toast-box">
    {{toastMessage}}
  </view>
</view>
